---
title: "Proyecto Final Estadística Aplicada: Análisis de Créditos Agrícolas"
author: "Tanya Godoy/ Mathias Chaparro /Pilar RuizDiaz"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true 
    toc_depth: 3 
    code_folding: hide 
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
# Configuración global de los 'chunks' de R
knitr::opts_chunk$set(
  echo = TRUE, # Mostrar el código en el informe
  message = FALSE, # Ocultar mensajes de R
  warning = FALSE, # Ocultar advertencias de R
  fig.align = 'center', # Centrar todas las figuras
  fig.width = 10,
  fig.height = 6
)
```

# 1. Introducción y Configuración
El objetivo de este informe es analizar la distribución y evolución de los desembolsos de créditos para el sector AGRICULTURA, con un enfoque en la comparación por tipo de Moneda (Nacional vs. Extranjera) y el desempeño de los principales bancos.

## 1.1. Carga de Paquetes y Datos
Se cargan las librerías necesarias para el análisis (limpieza, manipulación, visualización y pruebas estadísticas) y se importa el conjunto de datos crudo.

```{r importacion_datos}
# 1. IMPORTACIÓN DE PAQUETES Y DATOS
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  tidyverse, 
  lubridate,
  janitor,
  gt,
  car,     # Para test de Levene
  rstatix,# Para verificación de supuestos de normalidad
  ggpubr, # Para verificación de supuestos de normalidad
  scales,   # Para formato
  broom
)

# Importar el conjunto de datos CSV (Asegúrate de que 'Cred_por_sector.csv' esté en tu directorio)
df_creditos_raw <- read_csv("Cred_por_sector.csv")

# Verificación inicial
message("Dimensiones y Estructura inicial del dataset:")
print(dim(df_creditos_raw))
print(glimpse(df_creditos_raw))

```

# 2. Preprocesamiento de Datos

Se aplican una serie de pasos de limpieza, filtrado, transformación y agregación para preparar el dataset para el análisis, enfocándose en el sector AGRICULTURA y consolidando las fusiones bancarias.

```{r preprocesamiento}
# 2. PREPROCESAMIENTO: LIMPIEZA, ORDENACIÓN Y TRANSFORMACIÓN
df_final <- df_creditos_raw %>%
  # Paso 1: Limpieza de nombres de columnas (limpia espacios, mayúsculas, etc.) 
  clean_names() %>%
  
  # Paso 2: Filtrar por sector AGRICULTURA 
  filter(sector_e == "AGRICULTURA") %>%
  
  # Paso 3: Conversión de la columna 'fecha' a formato Date (YYYY-MM-01) 
  mutate(
    fecha = ymd(paste0(fecha, "/01"))
  ) %>%
  
  # Paso 4: Eliminar la columna 'sector_e' 
  select(-sector_e) %>%
  
  # Paso 5: Transponer/Pivotar a formato largo 
  pivot_longer(
    cols = -c(fecha, moneda),
    names_to = "banco",
    values_to = "monto_credito"
  ) %>%
  
  # Paso 6: Reemplazar y fusionar nombres de bancos 
  mutate(
    banco = case_when(
      banco == "gnb_fusion" ~ "gnb",
      banco == "regional" ~ "sudameris",
      banco == "vision" ~ "ueno",
      TRUE ~ banco # Mantener el resto de nombres sin cambios
    ),
    # Asegurar que el monto sea numérico
    monto_credito = as.numeric(monto_credito)
  ) %>%
  
  # Paso 7: Agrupar la data por la fusión de bancos
  group_by(fecha, moneda, banco) %>%
  summarise(
    monto_credito = sum(monto_credito, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  
  # Paso 8: Filtrar valores extremos/inconsistentes (monto_credito > 0)
  filter(monto_credito > 0)

# Paso Final: Verificación post-limpieza
message("\nDimensiones y Estructura del dataset FINAL (limpio y largo):")
print(dim(df_final))
print(glimpse(df_final))

```

# 3. Exploración de Datos (EDA)
Esta sección presenta un resumen de los datos limpios, incluyendo estadísticas descriptivas por moneda y banco, y visualizaciones clave.


## 3.1. Resumen Estadístico por Moneda
Se comparan las principales estadísticas de los créditos entre Moneda Nacional (MN) y Moneda Extranjera (ME).

```{r exploracion, results='asis', echo=FALSE, results='hide'}
# === ANÁLISIS DESCRIPTIVO POR MONEDA ===
df_resumen_moneda <- df_final %>%
  group_by(moneda) %>%
  summarise(
    Conteo_Total = n(),
    Monto_Total = sum(monto_credito),
    Monto_Promedio = mean(monto_credito),
    Monto_Mediana = median(monto_credito),
    Desviacion_Std = sd(monto_credito)
  )

message("\nResumen Estadístico por Moneda:")
print(df_resumen_moneda)
```
```{r exploracion_res, results='asis', echo=FALSE}
# TABLA PROFESIONAL CON 'gt'
df_resumen_moneda %>%
  gt() %>%
  tab_header(
    title = "Resumen de Créditos Agrícolas por Tipo de Moneda"
  ) %>%
  fmt_number(
    columns = starts_with("Monto_"),
    decimals = 0,
    use_seps = TRUE
  )

```
### Explicacion Desviacion Estandar
**Moneda Extranjera:**  Alta Dispersión. Los créditos en Moneda Extranjera tienen una variabilidad muy alta. Esto sugiere que hay una gran diferencia entre los créditos más pequeños y los más grandes, siendo el promedio (1.2 millones) menos representativo de un crédito típico individual. La desviación es incluso mayor que el promedio, lo que confirma la extrema heterogeneidad de los montos.

**Moneda Nacional:** Alta Dispersión. Los créditos en Moneda Nacional también tienen una dispersión significativa, ya que la desviación es casi igual al Monto Promedio. No obstante, en términos absolutos, la dispersión es mucho menor que en ME (180 mil vs. 1.58 millones).



## 3.2. Estadísticas Descriptivas Detalladas por Banco y Moneda
Tabla detallada que muestra la dispersión y tendencia central de los desembolsos para cada combinación de banco y tipo de moneda.

```{r exploracioni,results='asis'}
# 1. Cálculo de las métricas clave (Media, SD, Quartiles)
descriptivos_detallados <- df_final %>%
  group_by(banco, moneda) %>%
  summarise(
    N_obs = n(),
    Media = mean(monto_credito),
    DS = sd(monto_credito),
    Q1 = quantile(monto_credito, 0.25),
    Mediana = median(monto_credito),
    Q3 = quantile(monto_credito, 0.75),
    .groups = 'drop'
  )

# 2. Presentación Profesional con gt
tabla_descriptiva_completa <- descriptivos_detallados %>%
  gt() %>%
  tab_header(
    title = "Estadísticas Descriptivas Detalladas de Desembolsos por Banco",
    subtitle = "Sector: Agricultura. Valores en Guaraníes (G)"
  ) %>%
  # Redondeo y formato de números grandes (en Guaraníes)
  fmt_number(
    columns = c(Media, DS, Q1, Mediana, Q3),
    decimals = 0,
    use_seps = TRUE
  ) %>%
  # Etiquetado y Alineación
  cols_label(
    banco = "Banco",
    moneda = "Moneda",
    N_obs = "N",
    DS = "Desv. Est.",
    Q1 = "Cuartil 1 (Q1)",
    Mediana = "Mediana (Q2)",
    Q3 = "Cuartil 3 (Q3)"
  ) %>%
  # Añadir estilo visual (opcional)
  data_color(
    columns = c(Media, DS),
    palette = "Blues"
  )

print(tabla_descriptiva_completa)

```

## 3.3. Ranking de Bancos (Monto Total)
Identificación de los 5 bancos con el mayor monto total de crédito agrícola en el periodo analizado.

```{r exploracionii, results='asis'}
# === RANKING DE BANCOS ===
df_top_bancos <- df_final %>%
  group_by(banco) %>%
  summarise(Monto_Total_Credito = sum(monto_credito), .groups = 'drop') %>%
  arrange(desc(Monto_Total_Credito)) %>%
  head(5)

# TABLA PROFESIONAL CON 'gt'
tabla_top_bancos <- df_top_bancos %>%
  gt() %>%
  tab_header(
    title = "Top 5 Bancos con Mayor Monto Total de Crédito Agrícola",
    subtitle = "Periodo Analizado"
  ) %>%
  fmt_number(
    columns = Monto_Total_Credito,
    decimals = 0,
    use_seps = TRUE
  ) %>%
  cols_label(
    banco = "Banco",
    Monto_Total_Credito = "Monto Total Crédito"
  ) %>%
  data_color(
    columns = Monto_Total_Credito,
    palette = "Greens"
  )

print(tabla_top_bancos)

```

# 3.4. Visualizaciones Clave
## Evolución Mensual del Crédito por Moneda
Muestra cómo ha evolucionado el monto total de crédito, diferenciando entre Moneda Nacional (MN) y Moneda Extranjera (ME).

```{r evolucion, results='asis'}
# === GRÁFICO 1: EVOLUCIÓN TEMPORAL POR MONEDA ===
grafico_tiempo <- df_final %>%
  group_by(fecha, moneda) %>%
  summarise(credito_total = sum(monto_credito), .groups = 'drop') %>%
  
  ggplot(aes(x = fecha, y = credito_total, color = moneda)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) + # Formato legible para el eje Y
  labs(
    title = "Evolución Mensual del Crédito Agrícola",
    subtitle = "Total por Moneda Nacional (MN) vs. Moneda Extranjera (ME)",
    x = "Fecha",
    y = "Monto Total de Crédito",
    color = "Tipo de Moneda"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )

print(grafico_tiempo)

```

##  Participación Bancaria por Moneda

Gráfico de barras apiladas que ilustra la contribución de cada banco al crédito total y su distribución entre MN y ME.

```{r evolucioni, results='asis'}
# === GRÁFICO 2: PARTICIPACIÓN BANCARIA POR MONEDA ===
grafico_bancos <- df_final %>%
  # Agrupamos la data para tener la participación total de cada banco
  group_by(banco, moneda) %>%
  summarise(credito_total = sum(monto_credito), .groups = 'drop') %>%
  
  # Ordenamos los bancos por el monto total para mejor lectura
  mutate(banco = fct_reorder(banco, credito_total, .fun = sum)) %>%
  
  ggplot(aes(x = banco, y = credito_total, fill = moneda)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_y_continuous(labels = scales::comma) +
  coord_flip() + # Para mejor lectura de nombres de bancos
  labs(
    title = "Participación Total de Bancos en Crédito Agrícola",
    subtitle = "Separado por Tipo de Moneda",
    x = "Banco",
    y = "Monto Total de Crédito",
    fill = "Moneda"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )

print(grafico_bancos)

```

# 4. Pruebas de Hipótesis
## 4.1. T-Test: Comparación MN vs. ME
Hipótesis Nula ($H_0$): No existe una diferencia estadísticamente significativa en el monto promedio de crédito entre Moneda Nacional (MN) y Moneda Extranjera (ME).

Verificación de Supuestos T-Test
La prueba $T$ de Student tiene dos supuestos principales: Normalidad y Homogeneidad de Varianzas.

```{r pht_test, results='hide', message=FALSE, warning=FALSE}
# 1.1 Normalidad (Test de Shapiro-Wilk para cada grupo)
normalidad_mn_me <- df_final %>%
  group_by(moneda) %>%
  rstatix::shapiro_test(monto_credito)

# 1.2 Inspección Visual de Normalidad (QQ Plot)
normalidad_qq_plot <- ggplot(df_final, aes(sample = monto_credito, color = moneda)) +
  geom_qq() +
  geom_qq_line() +
  facet_wrap(~ moneda) +
  labs(title = "QQ Plot de Monto de Crédito por Moneda")

# 1.3 Homogeneidad de Varianzas (Test de Levene)
levene_test_mn_me <- car::leveneTest(monto_credito ~ moneda, data = df_final)

# Decisión sobre la varianza a usar en el T-Test
var_iguales <- levene_test_mn_me$`Pr(>F)`[1] >= 0.05

```
### 1. Supuesto de Normalidad (Test de Shapiro-Wilk y QQ Plot)
### a) Resultados del Test de Shapiro-Wilk

```{r tabla shapiro, echo=FALSE}
# Re-crear el data frame de resultados para kable
normalidad_tabla <- normalidad_mn_me %>%
  select(moneda, statistic, p) %>%
  rename(Moneda = moneda, `Estadístico W` = statistic) %>%
  
  mutate(
    `Conclusión (α=0.05)` = ifelse(p < 0.05, "Rechaza H0 (No Normal)", "No Rechaza H0"),
    `P-valor` = formatC(p, format = "e", digits = 2), # Formato científico
  ) %>%
  select(-p)

knitr::kable(normalidad_tabla, 
             caption = "Resultados del Test de Shapiro-Wilk",
             align = c('l', 'c', 'c', 'l'))

```


El $P$-valor es menor a $0.05$ para ambos grupos, indicando un incumplimiento severo del supuesto de Normalidad.

### b) Inspección Visual (QQ Plot)
```{r grf_qqplot, echo=FALSE, message=FALSE, warning=FALSE}
fig.cap="Grafico de supuestos de normalidad"
print(normalidad_qq_plot)
```
**Observación:** La desviación de los puntos respecto a la línea diagonal confirma la no-normalidad, especialmente en los extremos, sugiriendo una distribución sesgada y con posibles outliers.

### 2. Supuesto de Homogeneidad de Varianzas (Test de Levene)
Este test verifica si las varianzas de los montos de crédito son iguales entre MN y ME.

```{r tabla levene, echo=FALSE}
levene_p_valor <- data.frame(
  Métrica = c("Estadístico F", "P-valor Levene"),
  Valor = c(
    round(levene_test_mn_me$F[1], 3),
    formatC(levene_test_mn_me$`Pr(>F)`[1], format = "e", digits = 5)
  )
)
knitr::kable(levene_p_valor, caption = "Resultados del Test de Levene", align = 'lr')
```

### Decisión sobre la Varianza:

El P-valor de Levene es `r formatC(levene_test_mn_me[1, 3], format = "e", digits = 5)`.

Como `r formatC(levene_test_mn_me[1, 3], format = "e", digits = 5)` es `r if (var_iguales) "MAYOR O IGUAL" else "MENOR"` a $\alpha = 0.05$, las varianzas se consideran `r if (var_iguales) "Homogéneas (Iguales)" else "Heterogéneas (Diferentes)"`.

**Conclusión:** 
Se debe utilizar el T-Test de Welch (`var.equal=FALSE`), ya que es robusto tanto a la falta de normalidad (con muestras grandes) como a la desigualdad de varianzas.


### 1. Moneda Extranjera (ME)
**Distribución: **Altamente NO Normal.

**Observación:** Los puntos se desvían drásticamente de la línea de referencia, especialmente en los extremos.
Cerca de 0, los puntos están muy por debajo de la línea.

En los valores positivos (hacia la parte superior), los puntos se disparan muy por encima de la línea.

Esta forma es típica de una distribución con una cola derecha muy pesada (sesgo positivo extremo) y la presencia de valores atípicos (outliers) de montos de crédito muy altos que estiran la distribución.

### 2. Moneda Nacional (MN)
**Distribución:** NO Normal, pero con menor desviación.

**Observación:** Aunque los puntos siguen la línea de referencia central de forma aproximada, hay una leve curvatura y los puntos se apartan de la línea en los extremos.

La distribución no es perfectamente normal; muestra un sesgo ligero (probablemente también positivo, aunque menos severo que ME) o es ligeramente más aplanada que una distribución normal.

## Ejecución del T-Test


```{r pht_testi, results='hide'}
# 2. Ejecución del T-Test
t_test_resultado <- t.test(monto_credito ~ moneda, data = df_final, var.equal = var_iguales)

print(t_test_resultado)

# 3. Interpretación Narrativa
p_val_ttest <- t_test_resultado$p.value
media_mn <- df_final %>% filter(moneda == "MN") %>% pull(monto_credito) %>% mean()
media_me <- df_final %>% filter(moneda == "ME") %>% pull(monto_credito) %>% mean()

message("\n--- INTERPRETACIÓN T-TEST ---")
if (p_val_ttest < 0.05) {
  message(paste("Conclusión: Se RECHAZA la Hipótesis Nula. Existe una diferencia estadísticamente significativa en el monto promedio de crédito entre Moneda Nacional y Moneda Extranjera (P-valor =", round(p_val_ttest, 10), ")."))
} else {
  message(paste("Conclusión: NO se puede rechazar la Hipótesis Nula. No existe una diferencia significativa (P-valor =", round(p_val_ttest, 10), ")."))
}
message(paste("Media MN:", scales::comma(media_mn, accuracy = 0.01), " | Media ME:", scales::comma(media_me, accuracy = 0.01)))

```
```{r Tabla T-Test, echo=FALSE}
library(dplyr)
library(tibble) # para rownames_to_column

# Extracción de valores clave (misma lógica que antes)
resultados_ttest <- data.frame(
  Estadístico_t = round(t_test_resultado$statistic, 3),
  Grados_Libertad = round(t_test_resultado$parameter, 0),
  Valor_p = formatC(t_test_resultado$p.value, format = "e", digits = 2),
  Media_ME = round(t_test_resultado$estimate[1], 0),
  Media_MN = round(t_test_resultado$estimate[2], 0)
) %>%
  t() %>% # Transponer
  as.data.frame() %>% # Convertir a data frame
  rownames_to_column(var = "Métrica") %>%
  
    setNames(c("Métrica", "Valor")) 

# Presentación con kable
knitr::kable(resultados_ttest, caption = "Resultados de la Prueba t de Welch")

```
### Observacion
Valor_p de 6,07 x 10^-126 a partir de los resultados de la Prueba T de Welch es que existe una diferencia estadísticamente significativa entre las medias de los dos grupos (Media_ME y Media_MN).
Se rechaza la hipotesis nula.


# 4.2. ANOVA: Comparación de medias Top 5 Bancos (en ME)


Se aísla el grupo de Moneda Extranjera (ME) para comparar si el monto promedio de crédito varía entre los 5 principales bancos que operan en esta moneda

Hipótesis Nula ($H_0$): No existe una diferencia estadísticamente significativa en el monto promedio de crédito en ME entre el Top 5 de bancos.

## Preparación del Dataset

```{r pht_anova, results='asis',message=TRUE}
# === CREACIÓN DE df_final_me (Para el análisis ANOVA) ===
message("\n--- CREANDO DATAFRAME FILTRADO POR MONEDA EXTRANJERA (ME) ---")

df_final_me <- df_final %>%
  filter(moneda == "ME")

# Identificamos los 5 principales bancos DENTRO de la muestra de ME
top_5_bancos_me <- df_final_me %>%
  group_by(banco) %>%
  summarise(Monto_Total_Credito = sum(monto_credito), .groups = 'drop') %>%
  arrange(desc(Monto_Total_Credito)) %>%
  head(5) %>%
  pull(banco)

df_anova_me <- df_final_me %>%
  filter(banco %in% top_5_bancos_me)

message(paste("Dimensiones del df_anova_me (Top 5 Bancos en ME):", dim(df_anova_me)[1], "filas y", dim(df_anova_me)[2], "columnas"))

```

### Verificación de Supuestos ANOVA

El Análisis de Varianza (ANOVA) requiere dos supuestos principales: 

**Homogeneidad de Varianzas** : varianzas iguales entre grupos.

**Normalidad de los Residuos** :los errores del modelo siguen una distribución normal.


```{r pht_anovai, results='hide',message=FALSE}
# 1.1 Ejecución del Modelo ANOVA (necesario para obtener los residuos)
modelo_anova_me <- aov(monto_credito ~ banco, data = df_anova_me)

# 1.2 Homogeneidad de Varianzas (Test de Levene)
message("\n--- 1. Homogeneidad de Varianzas (Levene) ---")
levene_anova_me <- car::leveneTest(monto_credito ~ banco, data = df_anova_me)
print(levene_anova_me)

# 1.3 Normalidad de los Residuos (QQ-Plot Visual)
message("\n--- Inspección Visual de Normalidad (QQ Plot) ---")

residuos_anova <- data.frame(Residuos = residuals(modelo_anova_me))

qq_plot_anova <- ggpubr::ggqqplot(residuos_anova, x = "Residuos", title = "QQ Plot de Residuos del ANOVA")


```


```{r resul_levene, echo=FALSE}
levene_anova_p_valor <- data.frame(
  Métrica = c("Estadístico F", "P-valor Levene"),
  Valor = c(
    round(levene_anova_me$F[1], 3),
    formatC(levene_anova_me$`Pr(>F)`[1], format = "e", digits = 5)
  )
)
knitr::kable(levene_anova_p_valor, caption = "Resultados del Test de Levene para ANOVA", align = 'lr')

```
**Decisión:** Dado que el $P$-valor de Levene es`r formatC(levene_anova_me[1, 3], format = "e", digits = 5)`(comparado con $\alpha = 0.05$ ):

Si $P$-valor $< 0.05$ (lo más probable en datos financieros), se rechaza la hipótesis de varianzas iguales.

Si se rechaza, el supuesto de homogeneidad no se cumple, por lo que se recomienda usar un test ANOVA robusto como el ANOVA de Welch o la prueba de Kruskal-Wallis (dada la falta de normalidad extrema común en estos datos).

### Normalidad de los Residuos (QQ Plot Visual)
```{r grf_anova, echo=FALSE, message=FALSE, warning=FALSE}
fig.cap="Grafico de supuestos de normalidad"
print(qq_plot_anova)
```

**Observación:**

Si los puntos se desvían de la línea recta, el supuesto de normalidad de los residuos no se cumple. En datos de montos, es común observar colas pesadas o sesgos.
Lo que sugiere que la prueba paramétrica estándar (ANOVA clásico) no es la más adecuada.


### Análisis de Hipótesis: Comparación de Medias (ANOVA de Welch)

El objetivo es determinar si existe una diferencia estadísticamente significativa en el monto promedio de crédito en moneda extranjera entre los 5 principales bancos.

**Hipótesis Nula ($H_0$):** El monto promedio de crédito es igual para todos los bancos.


### Ejecución del ANOVA de Welch (Robusto)

Dado que los supuestos de Normalidad y Homogeneidad de Varianzas fueron incumplidos, se utiliza el **ANOVA de Welch** (`oneway.test` con `var.equal = FALSE`). 
Esta prueba es robusta ante varianzas desiguales.

```{r anova_welch_execution, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
# --- 2. EJECUCIÓN FINAL DE LA PRUEBA ANOVA DE WELCH ---
resultado_anova_welch <- oneway.test(monto_credito ~ banco, 
                                     data = df_anova_me, 
                                     var.equal = FALSE) 

p_valor_anova <- resultado_anova_welch$p.value

cat("###  \n")
# Usamos knitr::kable para formatear la salida del test de Welch
tabla_anova_welch <- data.frame(
  Métrica = c("Estadístico F", "Grados de Libertad", "P-valor"),
  Valor = c(
    round(resultado_anova_welch$statistic, 3), 
    round(resultado_anova_welch$parameter[1], 0), # Primer GL
    formatC(resultado_anova_welch$p.value, format = "e", digits = 3)
  )
)
knitr::kable(tabla_anova_welch, caption = "Resultados del ANOVA de Welch")

```

**Conclusión del ANOVA:**
El P-valor del ANOVA de Welch es `r formatC(p_valor_anova, format = "e", digits = 3)`. 

Dado que este valor es menor que el nivel de significancia de $\alpha = 0.05$, se RECHAZA la Hipótesis Nula ($H_0$).

Esto indica que existe una diferencia estadísticamente significativa en el monto promedio de crédito en Moneda Extranjera entre al menos dos de los bancos analizados.

### Análisis Post-Hoc: Prueba de Games-Howell
Dado que el ANOVA de Welch fue significativo y las varianzas son desiguales, se utiliza la prueba Post-Hoc de Games-Howell. 

Esta prueba es robusta y compara cada par de bancos para identificar dónde residen las diferencias.

```{r anova_prbgames, echo=TRUE, results='asis', message=FALSE, warning=FALSE}
if (p_valor_anova < 0.05) {
  # PREPARACIÓN DE DATOS PARA LA TABLA INTUITIVA (USANDO GT)
  tabla_games_howell_gt <- df_anova_me %>%
    rstatix::games_howell_test(monto_credito ~ banco) %>%
    dplyr::select(group1, group2, estimate, conf.low, conf.high, p.adj) %>%
    dplyr::rename(
      `Diferencia Media` = estimate,
      `IC Inferior` = conf.low,
      `IC Superior` = conf.high,
      `P-valor Ajustado` = p.adj
    ) %>%
    dplyr::mutate(
        `Comparación` = paste(group1, " vs ", group2)
    ) %>%
    dplyr::select(-group1, -group2)
    
  # GENERACIÓN DE LA TABLA PROFESIONAL CON 'GT'
  tabla_gt_final <- tabla_games_howell_gt %>%
    gt::gt() %>%
    gt::tab_header(
      title = gt::md("**Diferencias Significativas Post-Hoc (Games-Howell)**"),
      subtitle = "Monto Promedio de Crédito (ME) por pares de Bancos"
    ) %>%
    gt::fmt_number(
      columns = c(`Diferencia Media`, `IC Inferior`, `IC Superior`),
      decimals = 0,
      use_seps = TRUE 
    ) %>%
    gt::fmt_number(columns = `P-valor Ajustado`, decimals = 4) %>%
    gt::tab_style(
        style = gt::cell_fill(color = "#C3E6CB"), # Color verde para significativo
        locations = gt::cells_body(
            columns = `P-valor Ajustado`,
            rows = `P-valor Ajustado` < 0.05
        )
    ) %>%
    gt::cols_merge(
        columns = c(`IC Inferior`, `IC Superior`),
        pattern = "[{1}, {2}]"
    ) %>%
    gt::cols_label(
        `IC Inferior` = "Intervalo de Confianza 95%"
    ) %>%
    gt::tab_footnote(
        footnote = gt::md("**Significativo** si P-valor Ajustado < 0.05"),
        locations = gt::cells_column_labels(columns = `P-valor Ajustado`)
    )
    
  print(tabla_gt_final)
} else {
  # Este bloque es opcional, ya que el ANOVA fue significativo
}

```

**Interpretación de Games-Howell:**Las comparaciones resaltadas en verde (P-valor Ajustado $< 0.05$) indican los pares de bancos que tienen una diferencia media real en el monto de crédito. 

Si el P-valor Ajustado no está resaltado, la diferencia observada entre esos dos bancos puede deberse al azar.

### Visualizaciones para ANOVA (ME)
### a) Boxplot de Distribución de Crédito por Banco (ME)

```{r grf_boxcredito, echo=TRUE, message=FALSE, warning=FALSE}
# === GRÁFICO 1: BOXPLOT DE DISTRIBUCIÓN POR BANCO (ME) ===
grafico_boxplot_anova <- df_anova_me %>%
  ggplot(aes(x = fct_reorder(banco, monto_credito, .fun = median, .desc = TRUE), 
              y = monto_credito)) +
  geom_boxplot(aes(fill = banco), outlier.alpha = 0.3) + 
  scale_y_continuous(labels = scales::comma) + 
  labs(
    title = "Distribución del Monto de Crédito Agrícola (ME)",
    subtitle = "Comparación de la Variabilidad entre los 5 Principales Bancos",
    x = "Banco",
    y = "Monto de Crédito",
    fill = "Banco"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none" 
  )
print(grafico_boxplot_anova)
```

Este gráfico ilustra la variabilidad, la mediana y los valores atípicos del monto de crédito para cada banco.

**Mediana (línea central): **Muestra el valor central. Si las líneas centrales no se alinean, sugiere una diferencia.

**Cajas (Q1 a Q3):** Indican dónde se encuentra el $50\%$ central de los datos. Una caja más larga sugiere mayor varianza, lo que visualmente confirma el incumplimiento del supuesto de homogeneidad.

**Puntos:** Representan los valores atípicos (outliers), que son comunes en datos de montos de crédito y que refuerzan la necesidad de un test robusto como el ANOVA de Welch.

### b) Barras de Media con Intervalos de Confianza (IC 95%)

```{r grf_barconf, echo=TRUE, message=FALSE, warning=FALSE}
# === GRÁFICO 2: BARRAS DE MEDIA CON INTERVALOS DE CONFIANZA (IC) ===
grafico_barras_ic <- df_anova_me %>%
  group_by(banco) %>%
  summarise(
    media_credito = mean(monto_credito),
    se_credito = sd(monto_credito) / sqrt(n()),
    .groups = 'drop'
  ) %>%
  mutate(banco = fct_reorder(banco, media_credito)) %>% 
  
  ggplot(aes(x = banco, y = media_credito)) +
  geom_bar(stat = "identity", fill = "#0072B2") + 
  geom_errorbar(
    aes(ymin = media_credito - 1.96 * se_credito, 
        ymax = media_credito + 1.96 * se_credito),
    width = 0.2, 
    linewidth = 1
  ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Monto Promedio de Crédito (ME) con Intervalos de Confianza al 95%",
    subtitle = "La no-superposición de barras sugiere diferencia significativa.",
    x = "Banco",
    y = "Monto Promedio de Crédito"
  ) +
  coord_flip() + 
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", hjust = 0))

print(grafico_barras_ic)
```

Este gráfico se enfoca en la media, que es la medida central comparada por el ANOVA.

**Barras de Error (IC 95%):** Indican el rango de valores donde se encuentra la media poblacional con un $95\%$ de confianza.

**Significancia Visual:** Si los Intervalos de Confianza (las barras de error) de dos bancos no se solapan, esto proporciona una fuerte indicación visual de que la diferencia en el monto promedio entre esos dos bancos es estadísticamente significativa (coincidiendo con los hallazgos de Games-Howell).
