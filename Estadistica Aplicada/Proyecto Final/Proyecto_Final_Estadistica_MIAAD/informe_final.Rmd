---
title: "Proyecto Final Estadística Aplicada: Análisis de Créditos Agrícolas"
author: "Godoy_Chaparro_RuizDiaz"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true 
    toc_depth: 3 
    code_folding: hide 
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
# Configuración global de los 'chunks' de R
knitr::opts_chunk$set(
  echo = TRUE, # Mostrar el código en el informe
  message = FALSE, # Ocultar mensajes de R
  warning = FALSE, # Ocultar advertencias de R
  fig.align = 'center', # Centrar todas las figuras
  fig.width = 10,
  fig.height = 6
)
```

# 1. Introducción y Configuración
El objetivo de este informe es analizar la distribución y evolución de los desembolsos de créditos para el sector AGRICULTURA, con un enfoque en la comparación por tipo de Moneda (Nacional vs. Extranjera) y el desempeño de los principales bancos.

## 1.1. Carga de Paquetes y Datos
Se cargan las librerías necesarias para el análisis (limpieza, manipulación, visualización y pruebas estadísticas) y se importa el conjunto de datos crudo.

```{r importacion_datos}
# 1. IMPORTACIÓN DE PAQUETES Y DATOS
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  tidyverse, 
  lubridate,
  janitor,
  gt,
  car,     # Para test de Levene
  rstatix,# Para verificación de supuestos de normalidad
  ggpubr, # Para verificación de supuestos de normalidad
  scales,   # Para formato
  broom
)

# Importar el conjunto de datos CSV (Asegúrate de que 'Cred_por_sector.csv' esté en tu directorio)
df_creditos_raw <- read_csv("Cred_por_sector.csv")

# Verificación inicial
message("Dimensiones y Estructura inicial del dataset:")
print(dim(df_creditos_raw))
print(glimpse(df_creditos_raw))

```

# 2. Preprocesamiento de Datos

Se aplican una serie de pasos de limpieza, filtrado, transformación y agregación para preparar el dataset para el análisis, enfocándose en el sector AGRICULTURA y consolidando las fusiones bancarias.

```{r preprocesamiento}
# 2. PREPROCESAMIENTO: LIMPIEZA, ORDENACIÓN Y TRANSFORMACIÓN
df_final <- df_creditos_raw %>%
  # Paso 1: Limpieza de nombres de columnas (limpia espacios, mayúsculas, etc.) 
  clean_names() %>%
  
  # Paso 2: Filtrar por sector AGRICULTURA 
  filter(sector_e == "AGRICULTURA") %>%
  
  # Paso 3: Conversión de la columna 'fecha' a formato Date (YYYY-MM-01) 
  mutate(
    fecha = ymd(paste0(fecha, "/01"))
  ) %>%
  
  # Paso 4: Eliminar la columna 'sector_e' 
  select(-sector_e) %>%
  
  # Paso 5: Transponer/Pivotar a formato largo 
  pivot_longer(
    cols = -c(fecha, moneda),
    names_to = "banco",
    values_to = "monto_credito"
  ) %>%
  
  # Paso 6: Reemplazar y fusionar nombres de bancos 
  mutate(
    banco = case_when(
      banco == "gnb_fusion" ~ "gnb",
      banco == "regional" ~ "sudameris",
      banco == "vision" ~ "ueno",
      TRUE ~ banco # Mantener el resto de nombres sin cambios
    ),
    # Asegurar que el monto sea numérico
    monto_credito = as.numeric(monto_credito)
  ) %>%
  
  # Paso 7: Agrupar la data por la fusión de bancos
  group_by(fecha, moneda, banco) %>%
  summarise(
    monto_credito = sum(monto_credito, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  
  # Paso 8: Filtrar valores extremos/inconsistentes (monto_credito > 0)
  filter(monto_credito > 0)

# Paso Final: Verificación post-limpieza
message("\nDimensiones y Estructura del dataset FINAL (limpio y largo):")
print(dim(df_final))
print(glimpse(df_final))

```

# 3. Exploración de Datos (EDA)
Esta sección presenta un resumen de los datos limpios, incluyendo estadísticas descriptivas por moneda y banco, y visualizaciones clave.


## 3.1. Resumen Estadístico por Moneda
Se comparan las principales estadísticas de los créditos entre Moneda Nacional (MN) y Moneda Extranjera (ME).

```{r exploracion, results='asis'}
# === ANÁLISIS DESCRIPTIVO POR MONEDA ===
df_resumen_moneda <- df_final %>%
  group_by(moneda) %>%
  summarise(
    Conteo_Total = n(),
    Monto_Total = sum(monto_credito),
    Monto_Promedio = mean(monto_credito),
    Monto_Mediana = median(monto_credito),
    Desviacion_Std = sd(monto_credito)
  )

message("\nResumen Estadístico por Moneda:")
print(df_resumen_moneda)

# TABLA PROFESIONAL CON 'gt'
df_resumen_moneda %>%
  gt() %>%
  tab_header(
    title = "Resumen de Créditos Agrícolas por Tipo de Moneda"
  ) %>%
  fmt_number(
    columns = starts_with("Monto_"),
    decimals = 0,
    use_seps = TRUE
  )

```

## 3.2. Estadísticas Descriptivas Detalladas por Banco y Moneda
Tabla detallada que muestra la dispersión y tendencia central de los desembolsos para cada combinación de banco y tipo de moneda.

```{r exploracioni,results='asis'}
# 1. Cálculo de las métricas clave (Media, SD, Quartiles)
descriptivos_detallados <- df_final %>%
  group_by(banco, moneda) %>%
  summarise(
    N_obs = n(),
    Media = mean(monto_credito),
    DS = sd(monto_credito),
    Q1 = quantile(monto_credito, 0.25),
    Mediana = median(monto_credito),
    Q3 = quantile(monto_credito, 0.75),
    .groups = 'drop'
  )

# 2. Presentación Profesional con gt
tabla_descriptiva_completa <- descriptivos_detallados %>%
  gt() %>%
  tab_header(
    title = "Estadísticas Descriptivas Detalladas de Desembolsos por Banco",
    subtitle = "Sector: Agricultura. Valores en Guaraníes (G)"
  ) %>%
  # Redondeo y formato de números grandes (en Guaraníes)
  fmt_number(
    columns = c(Media, DS, Q1, Mediana, Q3),
    decimals = 0,
    use_seps = TRUE
  ) %>%
  # Etiquetado y Alineación
  cols_label(
    banco = "Banco",
    moneda = "Moneda",
    N_obs = "N",
    DS = "Desv. Est.",
    Q1 = "Cuartil 1 (Q1)",
    Mediana = "Mediana (Q2)",
    Q3 = "Cuartil 3 (Q3)"
  ) %>%
  # Añadir estilo visual (opcional)
  data_color(
    columns = c(Media, DS),
    palette = "Blues"
  )

print(tabla_descriptiva_completa)

```

## 3.3. Ranking de Bancos (Monto Total)
Identificación de los 5 bancos con el mayor monto total de crédito agrícola en el periodo analizado.

```{r exploracionii, results='asis'}
# === RANKING DE BANCOS ===
df_top_bancos <- df_final %>%
  group_by(banco) %>%
  summarise(Monto_Total_Credito = sum(monto_credito), .groups = 'drop') %>%
  arrange(desc(Monto_Total_Credito)) %>%
  head(5)

# TABLA PROFESIONAL CON 'gt'
tabla_top_bancos <- df_top_bancos %>%
  gt() %>%
  tab_header(
    title = "Top 5 Bancos con Mayor Monto Total de Crédito Agrícola",
    subtitle = "Periodo Analizado"
  ) %>%
  fmt_number(
    columns = Monto_Total_Credito,
    decimals = 0,
    use_seps = TRUE
  ) %>%
  cols_label(
    banco = "Banco",
    Monto_Total_Credito = "Monto Total Crédito"
  ) %>%
  data_color(
    columns = Monto_Total_Credito,
    palette = "Greens"
  )

print(tabla_top_bancos)

```

# 3.4. Visualizaciones Clave
## Evolución Mensual del Crédito por Moneda
Muestra cómo ha evolucionado el monto total de crédito, diferenciando entre Moneda Nacional (MN) y Moneda Extranjera (ME).

```{r evolucion, results='asis'}
# === GRÁFICO 1: EVOLUCIÓN TEMPORAL POR MONEDA ===
grafico_tiempo <- df_final %>%
  group_by(fecha, moneda) %>%
  summarise(credito_total = sum(monto_credito), .groups = 'drop') %>%
  
  ggplot(aes(x = fecha, y = credito_total, color = moneda)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) + # Formato legible para el eje Y
  labs(
    title = "Evolución Mensual del Crédito Agrícola",
    subtitle = "Total por Moneda Nacional (MN) vs. Moneda Extranjera (ME)",
    x = "Fecha",
    y = "Monto Total de Crédito",
    color = "Tipo de Moneda"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )

print(grafico_tiempo)

```

##  Participación Bancaria por Moneda

Gráfico de barras apiladas que ilustra la contribución de cada banco al crédito total y su distribución entre MN y ME.

```{r evolucioni, results='asis'}
# === GRÁFICO 2: PARTICIPACIÓN BANCARIA POR MONEDA ===
grafico_bancos <- df_final %>%
  # Agrupamos la data para tener la participación total de cada banco
  group_by(banco, moneda) %>%
  summarise(credito_total = sum(monto_credito), .groups = 'drop') %>%
  
  # Ordenamos los bancos por el monto total para mejor lectura
  mutate(banco = fct_reorder(banco, credito_total, .fun = sum)) %>%
  
  ggplot(aes(x = banco, y = credito_total, fill = moneda)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_y_continuous(labels = scales::comma) +
  coord_flip() + # Para mejor lectura de nombres de bancos
  labs(
    title = "Participación Total de Bancos en Crédito Agrícola",
    subtitle = "Separado por Tipo de Moneda",
    x = "Banco",
    y = "Monto Total de Crédito",
    fill = "Moneda"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold")
  )

print(grafico_bancos)

```

# 4. Pruebas de Hipótesis
## 4.1. T-Test: Comparación MN vs. ME
Hipótesis Nula ($H_0$): No existe una diferencia estadísticamente significativa en el monto promedio de crédito entre Moneda Nacional (MN) y Moneda Extranjera (ME).

Verificación de Supuestos T-Test

```{r pht_test, results='asis'}
# 1.1 Normalidad (Test de Shapiro-Wilk para cada grupo)
message("\n--- 1. Normalidad (Shapiro-Wilk por grupo) ---")
normalidad_mn_me <- df_final %>%
  group_by(moneda) %>%
  rstatix::shapiro_test(monto_credito)
print(normalidad_mn_me)

# 1.2 Inspección Visual de Normalidad (QQ Plot)
message("\n--- Inspección Visual de Normalidad (QQ Plot) ---")
normalidad_qq_plot <- ggplot(df_final, aes(sample = monto_credito, color = moneda)) +
  geom_qq() +
  geom_qq_line() +
  facet_wrap(~ moneda) +
  labs(title = "QQ Plot de Monto de Crédito por Moneda")
print(normalidad_qq_plot)

# 1.3 Homogeneidad de Varianzas (Test de Levene)
levene_test_mn_me <- car::leveneTest(monto_credito ~ moneda, data = df_final)
message("\n--- 2. Homogeneidad de Varianzas (Levene) ---")
print(levene_test_mn_me)

# Decisión sobre la varianza a usar en el T-Test
var_iguales <- levene_test_mn_me$`Pr(>F)`[1] >= 0.05
message(paste("Decisión sobre Varianza (p-valor Levene):", if (var_iguales) "Usar T-Test Clásico (var.equal=TRUE)" else "Usar T-Test de Welch (var.equal=FALSE)"))

```

## Ejecución del T-Test


```{r pht_testi, results='asis',message=TRUE}
# 2. Ejecución del T-Test
t_test_resultado <- t.test(monto_credito ~ moneda, data = df_final, var.equal = var_iguales)

print(t_test_resultado)

# 3. Interpretación Narrativa
p_val_ttest <- t_test_resultado$p.value
media_mn <- df_final %>% filter(moneda == "MN") %>% pull(monto_credito) %>% mean()
media_me <- df_final %>% filter(moneda == "ME") %>% pull(monto_credito) %>% mean()

message("\n--- INTERPRETACIÓN T-TEST ---")
if (p_val_ttest < 0.05) {
  message(paste("Conclusión: Se RECHAZA la Hipótesis Nula. Existe una diferencia estadísticamente significativa en el monto promedio de crédito entre Moneda Nacional y Moneda Extranjera (P-valor =", round(p_val_ttest, 10), ")."))
} else {
  message(paste("Conclusión: NO se puede rechazar la Hipótesis Nula. No existe una diferencia significativa (P-valor =", round(p_val_ttest, 10), ")."))
}
message(paste("Media MN:", scales::comma(media_mn, accuracy = 0.01), " | Media ME:", scales::comma(media_me, accuracy = 0.01)))

```

# 4.2. ANOVA: Comparación de Medias del Top 5 Bancos (en ME)


Se aísla el grupo de Moneda Extranjera (ME) para comparar si el monto promedio de crédito varía entre los 5 principales bancos que operan en esta moneda

Hipótesis Nula ($H_0$): No existe una diferencia estadísticamente significativa en el monto promedio de crédito en ME entre el Top 5 de bancos.

## Preparación del Dataset

```{r pht_anova, results='asis',message=TRUE}
# === CREACIÓN DE df_final_me (Para el análisis ANOVA) ===
message("\n--- CREANDO DATAFRAME FILTRADO POR MONEDA EXTRANJERA (ME) ---")

df_final_me <- df_final %>%
  filter(moneda == "ME")

# Identificamos los 5 principales bancos DENTRO de la muestra de ME
top_5_bancos_me <- df_final_me %>%
  group_by(banco) %>%
  summarise(Monto_Total_Credito = sum(monto_credito), .groups = 'drop') %>%
  arrange(desc(Monto_Total_Credito)) %>%
  head(5) %>%
  pull(banco)

df_anova_me <- df_final_me %>%
  filter(banco %in% top_5_bancos_me)

message(paste("Dimensiones del df_anova_me (Top 5 Bancos en ME):", dim(df_anova_me)[1], "filas y", dim(df_anova_me)[2], "columnas"))

```

## Verificación de Supuestos ANOVA

```{r pht_anovai, results='asis',message=TRUE}
# 1.1 Ejecución del Modelo ANOVA (necesario para obtener los residuos)
modelo_anova_me <- aov(monto_credito ~ banco, data = df_anova_me)

# 1.2 Homogeneidad de Varianzas (Test de Levene)
message("\n--- 1. Homogeneidad de Varianzas (Levene) ---")
levene_anova_me <- car::leveneTest(monto_credito ~ banco, data = df_anova_me)
print(levene_anova_me)

# 1.3 Normalidad de los Residuos (QQ-Plot Visual)
message("\n--- Inspección Visual de Normalidad (QQ Plot) ---")

residuos_anova <- data.frame(Residuos = residuals(modelo_anova_me))

qq_plot_anova <- ggpubr::ggqqplot(residuos_anova, x = "Residuos", title = "QQ Plot de Residuos del ANOVA")
print(qq_plot_anova)

```

## Ejecución del ANOVA y Post-Hoc (Tukey)

```{r pht_anovaii, results='asis'}
# 2. EJECUCIÓN FINAL DE LA PRUEBA ANOVA
resultado_anova <- summary(modelo_anova_me)

print(resultado_anova)
p_valor_anova <- resultado_anova[[1]]$`Pr(>F)`[1]

# 3. ANÁLISIS POST-HOC (Tukey HSD)
message("\n--- ANÁLISIS POST-HOC (Tukey HSD en ME) ---")

if (p_valor_anova < 0.05) {
# 1. Transformar el resultado TukeyHSD a un data frame con tidy()
# Nota: Accedemos a la lista '$banco' antes de 'tidy()'
tabla_tukey_gt <- TukeyHSD(modelo_anova_me)$banco %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "comparison") %>% # Convierte los rownames (comparaciones) en una columna
  as_tibble() %>% # Para asegurar que es un data frame limpio
  select(comparison, diff, lwr, upr, `p adj`) %>% # Seleccionar columnas clave (los nombres que da TukeyHSD)
  # Nombres originales de las columnas: diff, lwr, upr, p adj
  rename(
    estimate = diff, 
    conf.low = lwr, 
    conf.high = upr, 
    adj.p.value = `p adj`
  ) %>% 
  mutate(
    comparison = str_replace(comparison, "-", " vs "),
    significativo = adj.p.value < 0.05
  )  
  # 2. Presentar la tabla con gt
  tabla_tukey_presentacion <- tabla_tukey_gt %>%
    gt() %>%
    tab_header(
      title = "Diferencias Significativas Post-Hoc (Tukey HSD)",
      subtitle = "Comparación del Monto Promedio de Crédito (ME) entre Bancos"
    ) %>%
    fmt_number(
      columns = c(estimate, conf.low, conf.high),
      decimals = 0,
      use_seps = TRUE
    ) %>%
    fmt_number(columns = adj.p.value, decimals = 5) %>% # Formato el p-valor
    cols_label(
      comparison = "Comparación",
      estimate = "Diferencia Media",
      conf.low = "Límite Inferior (95% IC)",
      conf.high = "Límite Superior (95% IC)",
      adj.p.value = "P-valor Ajustado",
      significativo = "Significativo"
    ) %>%
    # Resaltar las diferencias significativas (donde p-valor < 0.05)
    data_color(
      columns = adj.p.value,
      palette = c("red", "white", "darkgreen"),
      domain = c(0, 0.05, 1) # Rojo para no significativo, Verde oscuro para significativo
    )
  
  print(tabla_tukey_presentacion) # <--- Imprimir la tabla formateada
  
  message("\nConclusión ANOVA: Se RECHAZA H0. Existe diferencia significativa en el monto promedio de crédito en ME entre al menos dos de los Top 5 bancos. El análisis Post-Hoc (Tukey HSD) muestra cuáles pares son diferentes.")
} else {
  message("\nConclusión ANOVA: NO se puede rechazar H0. Las medias de los Top 5 bancos en ME son estadísticamente iguales.")
}

```

# 4.3. Visualizaciones para ANOVA (ME)

## Boxplot de Distribución de Crédito por Banco (ME)

El boxplot muestra la distribución completa de los montos de crédito para cada banco, incluyendo la mediana, los cuartiles y los valores atípicos.


```{r pht_anovaiii, results='asis'}
# === GRÁFICO 1: BOXPLOT DE DISTRIBUCIÓN POR BANCO (ME) ===
grafico_boxplot_anova <- df_anova_me %>%
  ggplot(aes(x = fct_reorder(banco, monto_credito, .fun = median, .desc = TRUE), 
             y = monto_credito)) +
  geom_boxplot(aes(fill = banco), outlier.alpha = 0.3) +
  scale_y_continuous(labels = scales::comma) + 
  labs(
    title = "Distribución del Monto de Crédito Agrícola (ME)",
    subtitle = "Comparación de la Variabilidad entre los 5 Principales Bancos",
    x = "Banco",
    y = "Monto de Crédito",
    fill = "Banco"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "none" 
  )

print(grafico_boxplot_anova)

```

## Barras de Media con Intervalos de Confianza (IC 95%)

Este gráfico permite ver si los intervalos de confianza de las medias de dos bancos no se solapan, lo cual es una fuerte indicación visual de diferencia significativa.


```{r pht_anovav, results='asis'}
# === GRÁFICO 2: BARRAS DE MEDIA CON INTERVALOS DE CONFIANZA (IC) ===
grafico_barras_ic <- df_anova_me %>%
  # Calculamos la media y el error estándar (SE) para las barras de error
  group_by(banco) %>%
  summarise(
    media_credito = mean(monto_credito),
    se_credito = sd(monto_credito) / sqrt(n()),
    .groups = 'drop'
  ) %>%
  # Ordenamos los bancos por su media para el gráfico
  mutate(banco = fct_reorder(banco, media_credito)) %>% 
  
  ggplot(aes(x = banco, y = media_credito)) +
  # Barras
  geom_bar(stat = "identity", fill = "#0072B2") + 
  # Barras de Error (Usando el 95% IC: Media ± 1.96 * SE)
  geom_errorbar(
    aes(ymin = media_credito - 1.96 * se_credito, 
        ymax = media_credito + 1.96 * se_credito),
    width = 0.2, 
    linewidth = 1
  ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Monto Promedio de Crédito (ME) con Intervalos de Confianza al 95%",
    subtitle = "La no-superposición de barras sugiere diferencia significativa.",
    x = "Banco",
    y = "Monto Promedio de Crédito"
  ) +
  coord_flip() + # Para mejor lectura
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(face = "bold", hjust = 0))

print(grafico_barras_ic)

```











